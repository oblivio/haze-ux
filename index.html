<!DOCTYPE HTML>
<html>
	<head>
		<title>HAZE</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/> 
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
		<link rel="icon" href="favicon.ico" type="image/x-icon">
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<link rel="stylesheet" type="text/css" href="semanticui/dist/semantic.min.css">
		<link type="text/css" rel="stylesheet" href="js/magnific-popup/magnific-popup.css" />
		<link href='https://fonts.googleapis.com/css?family=Monoton' rel='stylesheet' type='text/css'>
<link rel="apple-touch-icon" sizes="57x57" href="icons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="icons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="icons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="icons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="icons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="icons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="icons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="icons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
<link rel="manifest" href="manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="icons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
		<style>
		#notificationsbtn.hasnotif{
			box-shadow: 0 0 0 5px rgb(249, 164, 16) inset !important;
		}
		@font-face {
		  font-family: 'Monoton';
		  font-style: normal;
		  font-weight: 400;
		  src: local('Monoton'), local('Monotvon-Regular'), url(assets/fonts/monoton.woff2) format('woff2');
		}
		.error-msg{
			display:none;
		}
		.has-changed{
			border: 0.25em solid red !important;
		}
		#main{
			margin:0 auto;
			padding-top:5em;
			width:100%;
			max-width:960px;
			
		}
		#blackbook-contents,#clear-blackbook-button{
			display:none;
		}
		#logo{
			font-family: "Monoton",cursive;
			font-size: 1.5em;
			letter-spacing: 1px;
		}
		#bb-card{
			display:none;
		}
		#login-card{
			display:none;
		}
		#blackbook-contents .ui.card{
			float:left;
		}
.slide.ng-enter,
.slide.ng-leave {
    -webkit-transition: all 1s ease;
    transition: all 1s ease;
}
.slide.ng-enter {
    left: 100%;
}
.slide.ng-enter-active {
    left: 0;
}
.slide.ng-leave {
    left: 0;
}
.slide.ng-leave-active {
    left: -100%;
}


		</style>
	</head>
	<body ng-app="hazeApp">
		<!-- Wrapper-->
			<div id="wrapper">

				<!-- Nav -->
					
					<nav onclick="" class="ui three item fixed green pointing menu">
					  	<a id="logo" class="item">
					  	
					  	HAZE
					  	</a>
						<a onclick="$('.active.item').removeClass('active');$(this).addClass('active')" id="blackbookbtn" href="#/" class=" item"><div class="ui  black basic  icon button"><i class="comments outline icon"></i></div></a>
						<a onclick="$('.active.item').removeClass('active');$(this).addClass('active')" id="createbtn" href="#/create" class="item"><div class="ui  black basic icon button"><i class="add icon"></i></div></a>

					</nav>
					
				<!-- Main -->
					<div id="main" class="">
						
						<!-- content-section -->
						<div class="slide" ng-view></div>
						<!-- /content-section -->
						
<article id="blackbook" style="display:none;" class="ui stacked segment">
	<div id="main-bb-cards" class="ui one fluid cards">
	<div id="bb-card" class="ui card ">
		  <div class="content">
 		      <div class="right floated">
		  		</div>
		    <div class="header user-alias">
		    					
		    </div>
		    <div class="meta">
		      <span class="category">Blackbook </span>
		      
		    </div>
		    <div class="description">
		    		      <button type="button" id="bb-refresh-btn" onclick="bbcheck()" class="ui right labeled floated icon green button"><i class="refresh icon"></i>Load Blackbook</button>
		    
		    	<button type="button" class="ui red labeled icon button" id="user-logout-btn"><i class="close icon"></i>Logout</button>
<!-- 		    	<a href="#/processinvite" class="ui orange right floated tiny button" id="invite-modal-open">Have an invite?</a> -->
		   
		    </div>
		  </div>
		  <div class="extra content">
		  	<div class="right floated author">
		  	<div id="" class="ui right labeled left icon tiny input">
				  <i class="tags icon"></i>
				  <input id="user-alias-input" placeholder="Enter Alias" type="text">
				  <a class="ui tag label" onclick="setUserAlias()">
				    Alias
				  </a>
				</div>
				<hr />
		  						<a  class="ui red left floated basic button" id="clear-blackbook-button">clear blackbook</a>
		  				   						<a class="ui teal right floated basic labeled icon button" id="notificationsbtn" href="#/notifications" ><i class="warning icon"></i>Notifications</a>
		  		
		  	</div>
		    <div class="left floated author">
		    	
<!-- 					  <a href="#/processinvite" class="ui orange fluid button" id="invite-modal-open">Have an invite?</a> -->
	
			
		    </div>
		    
		  </div>
		  
	</div>
	
	<div id="login-card" class="ui card ">
		  <div class="content">
 		      <div class="right floated">
		  		</div>
		    <div class="header">
  				Haze Login/Register
		    </div>
		    <div class="meta">
		      <span class="category">Enter your E-mail/Password</span>
		    </div>
		    <div class="description">
				<div id="" class="ui right left icon fluid tiny input">
				  <i class="user icon"></i>
				  <input id="user-email-input" placeholder="Enter E-mail" type="text">
				</div>
				<div id="" class="ui right left icon fluid tiny input">
				  <i class="lock icon"></i>
				  <input id="user-pwd-input" placeholder="Enter Password" type="password">
				</div>
				<div>
					<p class="error-msg wrongpwd">Couldn't login. Please try again.</p>
				</div>
		    </div>
		  </div>
		  <div class="extra content">
		    <div class="right floated author">
		    
			 <button type="button" class="ui orange fluid button" id="user-login-btn">Login</button>
				
		    </div>
		    
		  </div>
		  
	</div>
	
	</div>
		  
	<hr />
	<div  id="blackbook-contents" class="ui cards">
							
	</div>
	<br />
	<br />
					
</article>
						
									
					</div>

				<!-- Footer -->
					<div id="footer">
						&nbsp;
					</div>

			</div>

		<!-- Scripts -->
			
		<script src="phonegap.js"></script>
			
			<script src="js/vendor/firebase.js"></script>
			<script>
			  // Initialize Firebase
			  var config = {
			    apiKey: "AIzaSyBxI9ikQGIlADBazqyZ8ghxJLib-yRAw_U",
			    authDomain: "oblivious-haze.firebaseapp.com",
			    databaseURL: "https://oblivious-haze.firebaseio.com",
			    storageBucket: "oblivious-haze.appspot.com",
			  };
			  firebase.initializeApp(config);
			</script>	
		<!-- Optional -->
		
			<script src="assets/js/jquery.min.js"></script>
			<script src="semanticui/dist/semantic.min.js"></script>	
			<script src="js/vendor/fastclick.js"></script>
			
		
			<script src="js/magnific-popup/magnific-popup.js" ></script>
			<script src="js/vendor/angular.min.js"></script>
			<script src="js/vendor/angular-route.min.js"></script>
			
			<script src="js/vendor/bindonce.js"></script>
			<script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
	        <script src="js/vendor/load-image.all.min.js"></script>
	        <script src="js/vendor/sjcl.js?#"></script>
	        <script src="js/ghostpixels/vendor/rsvp.min.js?#"></script>
	        <script src="js/ghostpixels/ghostpixels.js?#"></script>
			<script src="js/vendor/base64.js?#"></script>
			<script src="js/vendor/rawdeflate.js?#"></script>
			<script src="js/vendor/rawinflate.js?#"></script>      
	    	<script src="js/identicon.js/pnglib.js?#"></script>
			<script src="js/identicon.js/identicon.js?#"></script>
	    	<script src="js/vendor/moment.js"></script>
	    	
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			
			<script src="js/haze.js"></script>
			
			
			
			<script>
				//localstorage shit
				
					var localEntries = [];

					var Entries = [];
					var Invites = [];
					var emaildictionary = {};
					
					var firebaseUID = false;
					var firebaseEmail = false;
					firebase.auth().onAuthStateChanged(function(user) {
						if (user) {
			      		    // User is signed in.
			      		    console.log('user',user.email);
			      		  firebaseUID = user.uid;
			      		  firebaseEmail = user.email;
			      		  
			      		firebase.database().ref('email2user/'+user.uid).set({
			      			  'email':firebaseEmail,
			      			  'uid':firebaseUID,
			      		});
			      		var invitesRef = firebase.database().ref('invites/' + firebaseUID);

			      		  
			      		invitesRef.on('value', function(snapshot) {
			      		  Invites = [];
			      			if(snapshot.val() == null){
			      			  console.log('gotcha');
			      			$("#notificationsbtn").removeClass('hasnotif');
			      			  return false;
			      		  }
			      		  $.each(snapshot.val(),function(inviteKey,tmpOBJ){
			      			  var tmpInviteObj = {
			      					  'invite_id':inviteKey,
			      					  'invited_by':tmpOBJ.invited_by,
			      					  'invite_code':tmpOBJ.invitecode
			      			  }
			      			  Invites.push(tmpInviteObj);
			      		  	});
			      		  console.log('Invites',Invites);
			      		$("#notificationsbtn").removeClass('hasnotif');
			      		  if(Invites.length > 0){
			      			  	$("#notificationsbtn").removeClass('hasnotif').addClass('hasnotif');
			      		  }
				      		 $.event.trigger({
				      		      type: "invites-pulled",
				      		      message: "Invites have been pulled",
				      		      time: new Date()
				      		    });
			      		});

						firebase.database().ref('email2user/').on('value', function(snapshot) {
							if(snapshot.val() == null){
				      			  console.log('gotcha');
				      			$("#notificationsbtn").removeClass('hasnotif');
				      			  return false;
				      		  }
		      		    	$.each(snapshot.val(),function(key,obj){
		      		    		emaildictionary[String(obj.email)] = String(obj.uid);
		      		    	});
							console.log('emaildictionary',emaildictionary);
						});
			      		
						}
					});
					

				function indexRouteDOMLoaded(){

		      		$("#blackbook-contents").html('');
		      		$("#blackbook").show();
		      		$("#notificationsbtn").removeClass('hasnotif');
		      		
		      		firebase.auth().onAuthStateChanged(function(user) {
		      		  if (user) {
		      		    // User is signed in.
		      		    console.log('userX',firebaseEmail);
		      		  
		      		  
		      		    $("#main-bb-cards .ui.card").hide();
		      		    $("#bb-card").show();
		      		    $("#blackbook-contents,#clear-blackbook-button").show();
		      		    $("#bb-refresh-btn").click();
		      		  	$("#user-logout-btn").off("click").on("click",function(){
		      		    	firebase.auth().signOut().then(function() {
		      		    	  // Sign-out successful.
		      		    	  console.log('successful logout');
		      		    	}, function(error) {
		      		    	  // An error happened.
		      		    		console.log('successful logout');
		      		    	});
		      		    });
		      		  } else {
		      		    // No user is signed in.
		      		    $("#main-bb-cards .ui.card").hide();
		      		    $("#login-card").show();
		      		    $("#blackbook-contents").hide();
		      		    $("#user-login-btn").off("click").on("click",function(e){
		      		    	e.preventDefault();
		      		    	var email = String( $("#user-email-input").val() ).toLowerCase().trim();
		      		    	var pwd = $("#user-pwd-input").val();
		      		    	$(".error-msg").hide();
		      		    	
		      		    	if(email != '' && pwd != ''){
			      		    	$("#user-pwd-input,#user-email-input").val('');
			      		    	firebase.auth().signInWithEmailAndPassword(email, pwd).catch(function(error) {
			      		    	  // Handle Errors here.
			      		    	  var errorCode = error.code;
			      		    	  var errorMessage = error.message;
			      		    	  // ...
			      		    	  console.log('errorCode',errorCode);
			      		    	  console.log('errorMessage',errorMessage);
			      		    	  
				      		    	  if(errorCode == 'auth/user-not-found'){
				      		    		firebase.auth().createUserWithEmailAndPassword(email, pwd).catch(function(create_error) {
					      		    		  // Handle Errors here.
					      		    		  var createErrorCode = create_error.code;
					      		    		  var createErrorMessage = create_error.message;
					      		    		  console.log('createErrorCode',createErrorCode);
					      		    		  console.log('createErrorMessage',createErrorMessage);
					      		    		  // ...
				      		    		}); 
				      		    	  }else if(errorCode == 'auth/wrong-password'){
				      		    		  $(".error-msg.wrongpwd").show();
				      		    	  }
			      		    	});
		      		    	}
		      		    	
		      		    });
		      		    
		      		    
		      		  }
		      		return false;
		      		});

		      		
				};
				
				function getEntryAlias(eID,eCat){
					var myAliasData = oblivious.blackbookGet('aliases');
					//oblivious.blackbookSet('aliases',entryID+":"+cat,String(newAlias));
					var alias = eID;
					$.each(myAliasData,function(i,tmpAlias){
						if(typeof tmpAlias !== 'undefined' && typeof tmpAlias.value !== 'undefined'){
							
							if(tmpAlias.key == String(eID+":"+eCat) && String(tmpAlias.value).length > 0){
								alias = tmpAlias.value;
								console.log('alias',alias);
								return false;
							}
								
						}
					});
					return alias;
				};
				function getIdenticon(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				function setUserAlias(){
					var newAlias = $('#user-alias-input').val();
					console.log('newAlias',newAlias);
 					oblivious.blackbookSet('aliases','me',String(newAlias));
					location.reload(true);
				};
				function setEntryAlias(entryid,category){
					var newAlias = $('#entry-alias-'+entryid+'-'+category).val();
					console.log('newAlias',newAlias);
 					oblivious.blackbookSet('aliases',entryid+":"+category,String(newAlias));
					location.reload(true);
				};
				//
				function createCardHTML(entry){
var cardHTML = "<div class='ui card' id='"+entry.category+"-"+entry.entryid+"' > "+
   			    	"<button style='display:none;' class='ui icon top attached labeled red button'><i class='delete icon'></i>remove</button>" +
				  "<div class='content'>"+
	      			"<div class='right floated'>"+
	      			"<img class='ui avatar image' src='"+getIdenticon(entry.entryid)+"'>"+
  					"</div>"+
    				"<div class='header'>"+entry.visiblename+"</div>"+
			    	"<div class='meta'>"+
			    	  "<span class='category'>haze entry</span>"+
			    	"</div>"+
				    "<div class='description'>"+
				      "<p></p>"+
				    "</div>"+
				  "</div>"+
				  "<div class='extra content'>"+
				    "<div class='right floated author'>"+
				    	"<div id='' class='ui right labeled left icon mini input'>"+
						  "<i class='tags icon'></i>"+
						  "<input id='entry-alias-"+entry.entryid+"-"+entry.category+"' placeholder='Enter Alias' type='text'>"+
						  "<a class='ui tag label' onclick='setEntryAlias(\""+entry.entryid+"\",\""+entry.category+"\")'>"+
						    "Alias"+
						  "</a>"+
						"</div>"+
						"<a href='#/invite/"+entry.category+"/"+entry.entryid+"' class='ui fluid button teal'>invite</a>"+
				    "</div>"+
				  "</div>"+
				"<a href='#/view/"+entry.category+"/"+entry.entryid+"' class='ui icon labeled bottom attached green button '><i class='eye icon'></i>view</a>"+
			"</div>";
			console.log('cardHTML',cardHTML);
			return cardHTML;
				};
				function getUserAlias(){
					var alias = '(Anonymous)';
					var myAliasData = oblivious.blackbookGet('aliases');
					//oblivious.blackbookSet('aliases',entryID+":"+cat,String(newAlias));

					$.each(myAliasData,function(i,tmpAlias){
						if(typeof tmpAlias !== 'undefined' && typeof tmpAlias.value !== 'undefined'){
							
							if(tmpAlias.key == 'me' && String(tmpAlias.value).length > 0){
								alias = tmpAlias.value;
								return false;
							}
								
						}
					});
					return alias;
				}
				function getBlackbookEntries(){
					var TmpEntries = [];
					var localCommCount = oblivious.blackbookGet('commentcount');
					console.log('getting blackbook entries!');
					$("#blackbook-contents").html('');
					var tmpHTML = '';
					$.each(localCommCount,function(j,cObj){						
							var tmpEntry = {
									'category':'',
									'entryid':'',
									'visiblename':'',
									'commentcount':'',
							};
							var tmpRaw = String(cObj.key).split(":");
							var tmpID = tmpRaw[0];
							var tmpCat = tmpRaw[1];
							tmpEntry.entryid = tmpID;
							tmpEntry.visiblename = getEntryAlias(tmpID,tmpCat);	
							tmpEntry.category = tmpCat;

							
							if(String(cObj.key) === String(tmpEntry.entryid+ ":" + tmpEntry.category) ){
								tmpEntry.commentcount = cObj.value;
							}
						
						if(typeof tmpEntry.category != 'undefined' && typeof tmpEntry.entryid != 'undefined' && typeof tmpEntry.commentcount != 'undefined' && tmpEntry.commentcount != -1 && tmpEntry.commentcount != '-1'){								
							TmpEntries.push(tmpEntry);
							localEntries.push( String(tmpEntry.entryid+ ":" + tmpEntry.category) );
							tmpHTML += createCardHTML(tmpEntry) ;
						}
							
					});
					$("#blackbook-contents").html( tmpHTML );
					
					return TmpEntries;
				}

				function bbcheck(){
							if(Entries.length == 0){
								Entries = getBlackbookEntries();
							}
							var currEntries = [];
					    	var newCommentCount = {};
					    	
					    	//api.blackbook({blackbookdata:Entries});
					    	
							$.post( "https://www.hazedaily.com/api/blackbook/", {blackbookdata: Entries})
							  .done(function( data ) {
							    var hasChanged = [];
							    	data = JSON.parse(data);
							    	console.log('data from bb check',data);
							    	
								    $.each(data,function(i,obj){
								    	//obj[0] is the entry
								    	console.log('obj',obj,obj.length);
								    	if(typeof obj.changed === 'undefined')
								    		return true; //skip
								    		
								    		
								    		if(obj.changed){
								    			var tmp = {
								    					'entryid':obj.entryid,
								    					'category':obj.category,
								    					'visiblename':obj.entryid
								    			};
								    			hasChanged.push(tmp);

								    		}
								    		currEntries.push(obj);	
								    		
								    });
								    
								    
								    
								    $.each(localEntries,function(ii,encodedentry){
										var tmpRaw = String(encodedentry).split(":");
										var tmpID = tmpRaw[0];
										var tmpCat = tmpRaw[1];
										
										var foundEntry = false;
										$.each(currEntries,function(jj,obj){
									    	//String(tmpEntry.entryid+ ":" + tmpEntry.category)
											console.log('obj-checkit',obj);
											if(obj.entryid == tmpID && obj.category == tmpCat){
												foundEntry = true;
												return false;
											}
											
									    });
										if(!foundEntry){
											console.log('entry no longer exists!');
									    	oblivious.blackbookSet('commentcount',tmpID +":"+tmpCat ,-1);
											location.reload(true);
										}else{
											console.log('entry still exists amigo');
										}
									});
								    //bb_hasChanged = hasChanged;
							    	console.log('hasChanged',hasChanged);
									
							    	$.each(hasChanged,function(k,tmpData){
							    		$("#"+tmpData.category+"-"+tmpData.entryid).addClass('has-changed');
							    	});
							    	
							  }, "json");
						};		
				window.setInterval(bbcheck,30000);
				bbcheck();
				var showImage = function(imgSRC){
					$("#modal-img-src").attr('src','');
					$("#modal-img-src").attr('src',imgSRC);
					
					$("#view-image-modal").modal('show');
				}
			</script>
			
			
			<script src="js/vendor/jquery.blockui.js"></script>
			
			<script>
			$(document).on("invites-pulled", function (evt) {
				console.log('InvitesPulled',Invites);
			});
			$.blockUI.defaults.message = "";
			
			var app = angular.module('hazeApp',  ['ngRoute']);
			app.controller('NotificationsCtrl',function($scope,$location,$interval,$routeParams){
				firebase.auth().onAuthStateChanged(function(user) {
					if (user) {
		      		    // User is signed in.
		      		    console.log('user',user.email);
		      		  
		      		var invitesRef = firebase.database().ref('invites/' + firebaseUID);


		      		  $("#notifications-container").html('');
		      		  
		      		invitesRef.on('value', function(snapshot) {
		      		  Invites = [];
		      		  if(snapshot.val() == null){
		      			  console.log('gotcha');
		      			$("#notificationsbtn").removeClass('hasnotif');
		      			  return false;
		      		  }
		      		  $.each(snapshot.val(),function(inviteKey,tmpOBJ){
		      			  var tmpInviteObj = {
		      					  'invite_id':inviteKey,
		      					  'invited_by':tmpOBJ.invited_by,
		      					  'invite_code':tmpOBJ.invitecode
		      			  }
		      			  Invites.push(tmpInviteObj);
		      		  	});
		      		  console.log('Invites',Invites);
		      		  var tmpHTML = '';
		      		  $.each(Invites,function(i,inviteObj){
		      			var cardHTML = "<div class='ui card' id='invite-"+inviteObj.invite_id+"' > "+
	   			    	"<button style='display:none;' class='ui icon top attached labeled red button'><i class='delete icon'></i>remove</button>" +
					  "<div class='content'>"+
		      			"<div class='right floated'>"+
		      			"<img class='ui avatar image' src='"+getIdenticon(inviteObj.invite_id)+"'>"+
	  					"</div>"+
	    				"<div class='header'>"+inviteObj.invite_id+"</div>"+
				    	"<div class='meta'>"+
				    	  "<span class='category'>haze invite</span>"+
				    	"</div>"+
					    "<div class='description'>"+
					      "<p></p>"+
					    "</div>"+
					  "</div>"+
					  "<div class='extra content'>"+
					    "<div class='right floated author'>"+
					    "</div>"+
					  "</div>"+
					  "<div class='ui two buttons'>"+
						"<a data-action='accept' data-inviteid='"+inviteObj.invite_id+"' class='ui icon labeled bottom attached green button accept-invite-btn '><i class='check icon'></i>Accept</a>"+
						"<a data-action='reject'  data-inviteid='"+inviteObj.invite_id+"' class='ui icon labeled bottom attached red button  reject-invite-btn'><i class='close icon'></i>Reject</a>"+
					"</div>"+
					"</div>";
						tmpHTML += cardHTML;
		      		  });
		      		  
		      		  if(Invites.length > 0){
// 		      			  	$("#notificationsbtn").removeClass('hasnotif').addClass('hasnotif');
		      			$("#notifications-container").html(tmpHTML);
		      			$('#notifications-container').on('click', '.accept-invite-btn,.reject-invite-btn', function () {
		      				$.blockUI();
		      				var invite_id = $(this).data('inviteid');
		      				var action = $(this).data('action');
		      				
		      				console.log('action',action);
		      				console.log('invite_id',invite_id);
		      				
		      				console.log('Action with Invites',Invites);
		      				var invite_code = '';
		      				for(var ii = 0; ii < Invites.length; ii++){
		      					var cInvite = Invites[ii];
		      					if(cInvite.invite_id == invite_id){
		      						invite_code = cInvite.invite_code;
		      						break;
		      					}
		      				}
		      				
				      		  
		      				var tmpInvitesRef = firebase.database().ref('invites/' + firebaseUID + '/'+invite_id);
		      				tmpInvitesRef.remove();
		      				
		      				switch(action){
		      				case "accept":
		      					var encodedinvite = invite_code;
		      					var decodedinvite = window.atob(encodedinvite);
		      					console.log('decodedinvite',decodedinvite);
		      					var str_parts = decodedinvite.split("#!");
		      					console.log('str_parts',str_parts);
		      					decodedinvite = oblivious._decrypt(str_parts[1],str_parts[0]);
		      					console.log('str_parts',str_parts);
		      					str_parts = decodedinvite.split("#!");
		      					console.log('str_parts',str_parts);
		      					var inviteid  = str_parts[0];
		      					var invitecategory = str_parts[1];
		      					var invitepwd = str_parts[2];
		      					var invitestatus;
		      					console.log('inviteid',inviteid);
		      					console.log('invitecategory',invitecategory);
		      					
		      					oblivious.getEntry(inviteid,'invites',function(){
		      						console.log('this@getentry',this);
		      						var invitedata = this[0];
		      						if(this[0].meta.krypi && this[0].meta.isinvite){
		      							//request password;

		      							var tmpData = String(invitedata.data).replace("#!k!#","");
		      							console.log('tmpData',tmpData);
		      							var pwd = invitepwd;//$("#encodedinvite-input").data('pwd');
		      							$("#encodedinvite-input").data('pwd','');$("#encodedinvite-input").val('');
		      							console.log('pwd',pwd);
		      							if(pwd){
		      								console.log('pwd',pwd);
		      								var eContents = oblivious._decrypt(pwd,tmpData);
		      								console.log('eContents',eContents);
		      								var decoded = eContents;
		      								console.log('decoded',decoded);
		      								var s = decoded.split("#");
		      								var invitestatus;
		      								
		      								if(s.length==4){
		      									var entryID = s[1];
		      									var entryKey = s[2];
		      									var entryCategory = s[3];
		      									console.log('entryID',entryID);
		      									console.log('entryKey',entryKey);
		      									console.log('entryCategory',entryCategory);
		      									
		      										
		      							        	
		      							        	oblivious.getEntryMeta(entryID,entryCategory,function(){
		      											console.log('this@getEMeta',this);
		      											var alreadyhaskey = false;//oblivious_module.blackbook._getEntryKey(entryID,entryCategory);
		      											
		      											var tmpKeys = oblivious.blackbookGet('keys');
		      											for(var jj = 0; jj < tmpKeys.length; jj++){
		      												var currKeyObj = tmpKeys[jj];
		      												if(currKeyObj.key == String(entryID + ':' + entryCategory)){
		      													alreadyhaskey = true;
		      													break;
		      												}
		      											}
		      											console.log('already',alreadyhaskey);
		      											if(alreadyhaskey){
		      												invitestatus = "You already have access to this entry.";
		      											}else{
		      												invitestatus = "Successfully processed invite!";
		      												if(entryKey == '(nokey)'){
		      													entryKey = false;
		      													invitestatus = "Successfully processed invite! - no key required for entry.";
		      												}
		      												oblivious.blackbookSet('entries',entryID+":"+entryCategory,entryID);
		      												oblivious.blackbookSet('keys',entryID+":"+entryCategory,entryKey);
		      												oblivious.blackbookSet('categories',entryID,entryCategory);
		      												oblivious.blackbookSet('commentcount',entryID+":"+entryCategory,1);
		      												oblivious.blackbookSet('meta',entryID+":"+entryCategory,this[0].meta);
		      										    	
		      										    	$("html, body").animate({ scrollTop: 0 }, "slow");
		      												$(".rvmodal").fadeOut();
		      												$("#rvmod-generic .generic-msg").text(invitestatus);
		      									        	$("#rvmod-generic").fadeIn();
		      									        	location.reload(true);
		      										    	//blackbookSet commentcount here
		      										    	//and @ create when populating blackbook
		      										    	//clicking view from public does not add to bb
		      											}
		      										});
		      								    	//blackbookSet('tokens',data.id,data.deletetoken);
		      								    	//blackbookSet commentcount here
		      								    	//and @ create when populating blackbook
		      								    	//clicking view from public does not add to bb
		      									
		      							    	//blackbookSet('tokens',data.id,data.deletetoken);
		      								}else{
		      									invitestatus = "Could not process invite.";
		      									$("html, body").animate({ scrollTop: 0 }, "slow");
		      									$(".rvmodal").fadeOut();
		      									$("#rvmod-generic .generic-msg").text(invitestatus);
		      						        	$("#rvmod-generic").fadeIn();
		      								}
		      								
		      							}else{
		      								var eContents = window.atob(invitedata);
		      								console.log('eContents',eContents);
		      							}
		      							
		      						}else{
		      							console.log('unencrypted invite data',invitedata.data);
		      						}
		      					});
		      					break;
		      				case "reject":
		      					location.reload(true);
		      					break;
		      				}//end switch
		      				
		      				
		      			});
		      		  }
			      		 $.event.trigger({
			      		      type: "invites-pulled",
			      		      message: "Invites have been pulled",
			      		      time: new Date()
			      		    });
		      		});

					
		      		
					}
				});
			});
			app.controller('HazeViewCtrl',function($scope,$location,$interval,$routeParams){
				var refreshEntryTimer = false;
				$scope.$on("$destroy", function() {
			        if (refreshEntryTimer) {
			        	clearInterval(refreshEntryTimer);
			        }
			    });
				$scope.getEntryHTML = function(entry){
					var hasImage = false;
					if(entry.image != ''){
						hasImage = true;
					}
					console.log('entry',entry);
					var listItemHTML = '<div class="item">'+
				    '<img class="ui avatar image" src="'+entry.identicon+'">'+
// 				    '<img class="ui avatar image" src="'+$scope.getIdenticon(btoa(entry.firebaseUID)) +'">'+
				    '<div class="right floated content">';
				    
				    if(hasImage){
				    	listItemHTML+= '<a data-lightbox="image" href="'+entry.image+'" class="ui icon button pink" ><i class="photo icon"></i></a>';
				    }
				    listItemHTML += '</div>'+
				    '<div class="content">'+
				     ' <div class="header">'+entry.author+'</div>'+
				    	entry.text +
				   ' </div>'+
				  '</div>';	
				  	return listItemHTML;
				};
				
			  
				$scope.getEntryAlias = function(eID,eCat){
					
					var myAliasData = oblivious.blackbookGet('aliases');
					//oblivious.blackbookSet('aliases',entryID+":"+cat,String(newAlias));
					var alias = eID;
					
					$.each(myAliasData,function(i,tmpAlias){
						if(typeof tmpAlias !== 'undefined' && typeof tmpAlias.value !== 'undefined'){
							console.log('tmpAlias',tmpAlias);
							if(tmpAlias.key == String(eID+":"+eCat) && String(tmpAlias.value).length > 0){
								alias = tmpAlias.value;
								console.log('alias',alias);
							}
								
						}
					});
					return alias;
				};
				
				$scope.entryid = $routeParams.eid;
				$scope.category = $routeParams.category;
				$scope.entryContents = false;
				$scope.entryPassword = '';

				$scope.hasChanged = [];
				
				$scope.currentComment = '';
				$scope.currentCommentImg = '';
				
				
				$scope.entryid = $routeParams.eid;
//					$scope.category = $routeParams.category;
//					$scope.entryContents = false;
//					$scope.entryPassword = '';

			
				$scope.getEntry = function(){
					var earlyExit = false;
					switch($location.path()){
					
				      case "/":
				      case "/create":
				    	 earlyExit = true;
				    	 break;
				      }
						if(earlyExit){
							return false;
						}
						oblivious.getEntry($scope.entryid,$scope.category,function(){
							console.log('this @ getEntry',this);
							var data = this;
							var eContents = false;
							if(data[1] == "Paste does not exist, has expired or has been deleted."){
								oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category ,-1);
								console.log('paste no existe',data[1]);
								$location.path('/');
							}else{
								if(data[0].meta.krypi == "1"){
									var pwd = $scope.entryPassword;
									if(pwd){
										eContents = oblivious._processGetEntry(data,$scope.entryid,pwd);
										
									}else{
										$location.path('/');
									}
							    }else{
							    	eContents = oblivious._processGetEntry(data,$scope.entryid,'');
							    }
							}
							$scope.entryContents = eContents.reverse();
						    
							
							$.each($scope.entryContents,function(k,tmpData){
								console.log('tmpData',tmpData);
							});
							
						});
						
			};
			
				
				$scope.hasPhoto = function(img){
					if(img == ''){
						return false;
					}else{
						return true;
					}
				};
				$scope.showImage = function(e){
					//view-image-modal
					//modal-img-src
					
					$("#modal-img-src").attr('src','');
					$("#modal-img-src").attr('src',e.image);
					
					$("#view-image-modal").modal('show');
					
				};

				var updateEntryContents = function(){
					if(String($location.path()).indexOf('/view/public/') == -1){
						console.log('not viewing an entry right now');
						return false;
					}
					oblivious.getEntry($scope.entryid ,$scope.category,function(){
						console.log('this @ getEntry',this);
						var data = this;
						var eContents,pwd;
						if(data[1] == "Paste does not exist, has expired or has been deleted."){
							oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category ,-1);
							$location.path('/');
						}else{
							if(data[0].meta.krypi == "1"){
								if($scope.entryPassword == '')
									pwd = prompt("Please enter password to decrypt");
								else
									pwd = $scope.entryPassword;
								if(pwd){
									eContents = oblivious._processGetEntry(data,$scope.entryid ,pwd);
								}else{
									
									$location.path('/');
								}
						    }else{
						    	eContents = oblivious._processGetEntry(data,$scope.entryid,'');
						    	
						    }
							$scope.$apply(function() {

								$scope.entryContents = eContents.reverse(); //reverse order
								$scope.entryPassword = pwd;
								
								console.log('eContents',eContents,$scope.entryContents );
								
				    			oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category , $scope.entryContents.length);
								
								if(eContents[eContents.length - 1].image != ""){

									$("#main-img").attr('src',eContents[eContents.length - 1].image);	
									$("#main-img").fadeIn();

								}
								
								$("#main-message").text(eContents[eContents.length - 1].text);
								
								$("#entry-avatar").attr('src', getIdenticon($scope.entryid));
								$("#entry-avatar").show();
								
								var tmpHTML = '';
								$("#entry-comments").html('');
								$.each(eContents,function(k,tmpData){
									tmpHTML += $scope.getEntryHTML(tmpData);
//										console.log('tmpHTML',tmpHTML);
								});
								
								$("#entry-comments").html(tmpHTML);
								
								$("[data-lightbox='image']").magnificPopup({
									  type: 'image'
									  // other options
								});
								
							});
						}
					});
				};
				
				refreshEntryTimer = setInterval(updateEntryContents,30000);
				updateEntryContents();
				$scope.sendComment = function(){
					$.blockUI();
					$scope.currentComment = $("#comment-text").val();
					
					if($scope.currentComment == '' && $scope.currentCommentImg == ''){
						console.log('no comment entered');
					}else{
						console.log('comment entered!');
						var d ={ comment:String($scope.currentComment),
					             imgdata:'',
					             userkey:'',
					             containsimage:0,
					             nickname:'',
// 					             'firebaseUID':firebaseUID
						     };
						if($scope.currentCommentImg != ''){
							d.imgdata = $scope.currentCommentImg;
							d.containsimage = 1;
						}
						console.log('d',d);
						oblivious.addEntryComment($scope.entryid, 
								$scope.category,
								d,function(){
								//reset comment form
								$("#addcommentform")[0].reset();
								location.reload(true);
						});
					}
				};
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				$scope.toggleComment = function(){
					console.log('toggling comment');
				
					$("#add-comment-form").transition('scale');
				};
				
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
					// Run after view loaded.
					$("#blackbook").hide();
					
					
					$('.dropdown')
			  		.dropdown({
			  		    //dropdown settings
		  		    })
			  		;
					oblivious._onchange('addimage-input-comment',function(){
						var imgData = String(this);
						$scope.$apply(function() {
							$scope.currentCommentImg = imgData;
						});
					});
					
					$('.checkbox')
			  		.checkbox();
					
				});
			});
			app.config(function ($httpProvider) {
			  $httpProvider.defaults.headers.common = {};
			  $httpProvider.defaults.headers.post = {};
			  $httpProvider.defaults.headers.put = {};
			  $httpProvider.defaults.headers.patch = {};
			});
			app.factory('api', function($http){
				var bb_hasChanged = [];
				var observerCallbacks = [];
				var notifyObservers = function(){
					angular.forEach(observerCallbacks, function(callback){
					      callback();
					    });
				};
			    return {
			    	registerObserverCallback: function(callback){
						observerCallbacks.push(callback);
					},
			    	bbhaschanged:function(){return bb_hasChanged},
			    	checkblackbook: function(){
			        
						bbcheck();
			        }
			    }               
			});
			app.controller('IndexCtrl',function($scope,$location,$timeout,$interval,$routeParams,api){
				
				console.log('dimelo pina este es el remix');
				
			});
			
			app.controller('CreateCtrl',function($scope,$location,$routeParams){
				$scope.$on("$destroy", function() {
					oblivious._disableClientCrypto();
			    });	
			
				$("#blackbookbtn").removeClass('active');
				$("#createbtn").addClass('active');
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
					$("#blackbook").hide();
			    	  
					oblivious._onchange('addimage-input',function(){
						var imgData = String(this);
						$scope.$apply(function() {
							$scope.newentry.image = imgData;
						});
					});
					// Run after view loaded.
					$('.dropdown')
			  		.dropdown({
			  		    //dropdown settings
		  		    })
			  		;
				 
					$('.checkbox')
			  		.checkbox();
					
					oblivious._disableClientCrypto();
					$('#cryptotoggle').on("change",function(){
						
						if($(this).checkbox('is checked')){
							console.log('enable crypto');	
							oblivious._enableClientCrypto();
						}else{
							console.log('disable crypto');
							oblivious._disableClientCrypto();
						}
					});
					
					$("#metadata_entry").on("change",function(){
						$("#metadata_preview").show();
						if($(this).val() == '')
							$("#metadata_preview").hide();
						
						var tmpJSON = $(this).val();
						try{
							tmpJSON = JSON.parse(tmpJSON);
							var tmpMeta = {};
							for (var attrname in tmpJSON) { 
								tmpMeta[attrname] = tmpJSON[attrname]; 
							}
							$scope.$apply(function() {
								$scope.newentry.meta = tmpMeta;
							});
							$("#metadata_preview").val( JSON.stringify(tmpJSON,null,2) );
						}catch(e){
							console.log('not valid JSON');
						}
						
					});	
					$('#cryptotoggle').click();
				});
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
				$scope.newentry =  {
						'image':'',
						'clientsidecrypto':'',
						'password':'',
						'message':'',
						'expiration':'',
						'metadata':'',
					};
				
				$scope.submitNewEntry = function(){
					$.blockUI();
				
					var entryDetails = {
						'image':'',
						'clientsidecrypto':'',
						'password':'',
						'message':'',
						'expiration':'',
						'metadata':'',
						'meta':'',
						'category':'public',
						'containsimage':0
					};
					entryDetails.clientsidecrypto = $('#cryptotoggle').checkbox('is checked');
					entryDetails.password = $('#entry-password').val();
					entryDetails.message = $("#entry-text").val();
					entryDetails.expiration = $("#entry-expiration").val();
					entryDetails.metadata = $("#metadata_entry").val();
					entryDetails.image = $scope.newentry.image;
					if(entryDetails.image != ''){
						entryDetails.containsimage = 1;
					}
					console.log('entry-details',entryDetails);
					
					var d ={ data:String(entryDetails.message),
				             expire:entryDetails.expiration,
				             opendiscussion: 1,
				             category:entryDetails.category,
				             userkey:entryDetails.password,
				             imgdata:entryDetails.image,
				             containsimage:entryDetails.containsimage,
// 				             'firebaseUID':firebaseUID
					     };
					for (var attrname in $scope.newentry.meta) { d[attrname] = $scope.newentry.meta[attrname]; }

					if(entryDetails.password != ''){
						//krypi-password
						//(newEntry,category,userKey,img_data){
						d.userkey = entryDetails.password;
					}
					if(entryDetails.image != ''){
						d.imgdata = entryDetails.image;
						d.containsimage = 1;
					}
					console.log('d',d);
					if(d.imgdata || d.userkey){
						console.log('krypi entry');
						oblivious.addKrypiEntry(d,function(){
							console.log('added!');
							location.reload(true);
						});
					}else{
						console.log('regular entry');
						oblivious.addEntry(d,function(){
							console.log('added!')
							location.reload(true);
						});
					}
// 					location.reload(true);
// 					$('#addentryform')[0].reset();
// 					$("html, body").animate({ scrollTop: 0 }, "slow");
					
				};
			});
			app.controller('HazeInviteViewCtrl',function($scope,$location,$routeParams){
				
				
				
				$scope.entryid = $routeParams.eid;
				$scope.category = $routeParams.category;
				
				var randomKey = sjcl.codec.base64.fromBits(sjcl.random.randomWords(8, 0), 0);
				$("#invite-pwd").val(randomKey);
				$scope.generateInvite = function(){
					if($("#invite-pwd").val() != ''){
							oblivious._generateInvite($scope.entryid ,$scope.category);
							//triggers encodedinvite:change()
							
					}
				};
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
					$("#blackbook").hide();
					$("#encodedinvite").off('change').on('change',function(){
						var inviteEmail = String($("#invite-email").val()).toLowerCase().trim();
						//clear fields
						$("#encoded-details").show();
						$("#encodedinvite-pwd").val( $("#invite-pwd").val() );
						$("#encodedinvite-email").val( inviteEmail );
// 						$("#invite-img-wrapper").fadeIn();	
						
						
						//add to firebase invite
						if(typeof emaildictionary[$("#encodedinvite-email").val()] !== 'undefined'){
							var userid = emaildictionary[$("#encodedinvite-email").val()];
							console.log('userid',userid);	
						
							firebase.database().ref('invites/'+userid).push({
				      			  'invitecode':$("#encodedinvite").val(),
				      			  'invited_by': firebaseUID,
				      			  'accepted':false,
				      			  'rejected':false
				      		});	
						}else{
							console.log('invalid email/user - Firebase',inviteEmail);
							$("#encodedinvite-email").val('(invalid email)');
						}
						
						$("#invite-pwd,#invite-email").val('');
						$("#invite-pwd").val( sjcl.codec.base64.fromBits(sjcl.random.randomWords(8, 0), 0) );
						
					});
				});
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
			});
			app.controller('HazeProcessInviteViewCtrl',function($scope,$location,$routeParams){

				$scope.process = function(){
					oblivious._processInvite('#invite-status');
				};
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
					$("#blackbook").hide();
					document.getElementById('decode-input').onchange = function(input) {
						var file    = document.getElementById('decode-input').files[0];
						if ( file ) {
					        var FR= new FileReader();
					        FR.onload = function(e) {
					        	
// 					        console.log('e.target.result',e.target.result);
// 					        	var password = prompt('Enter password (leave empty if none)');
					        	
								GhostPixels.decode('',e.target.result).then(function(decodedMessage){
									
									$("#encodedinvite-input").val(decodedMessage);
									//$("#encodedinvite-input").data('pwd',password);
									
					        	});
					        	
					        };       
					        FR.readAsDataURL( file );
					    }
					};
					$("#submit-invite-button").on("click",function(){
						oblivious._processInvite('#invite-status');
							$("#inviteform")[0].reset();
					});
					
				});
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
			});
			app.directive('loading',   ['$http' ,function ($http)
			                             {
		        return {
		            restrict: 'A',
		            link: function (scope, elm, attrs)
		            {
		                scope.isLoading = function () {
		                    return $http.pendingRequests.length > 0;
		                };

		                scope.$watch(scope.isLoading, function (v)
		                {
		                    if(v){
		                        elm.show();
		                    }else{
		                        elm.hide();
		                    }
		                });
		            }
		        };

		    }]);
			app.config(['$routeProvider',
			      	  function($routeProvider) {
			      	    $routeProvider.
			      	      when('/create', {
			      		        templateUrl: 'templates/create.html',
			      		        controller: 'CreateCtrl'
			      	      }).
			      	    when('/notifications', {
			      		        templateUrl: 'templates/notifications.html',
			      		        controller: 'NotificationsCtrl'
			      	      }).
			      	    when('/view/:category/:eid', {
		      		        templateUrl: 'templates/view.html',
		      		        controller: 'HazeViewCtrl'
		      	      	}).
		      	      when('/invite/:category/:eid', {
		      		        templateUrl: 'templates/invite.html',
		      		        controller: 'HazeInviteViewCtrl'
		      	      	}).
		      	      when('/processinvite', {
		      		        templateUrl: 'templates/processinvite.html',
		      		        controller: 'HazeProcessInviteViewCtrl'
		      	      	}).
			      	      otherwise({
			      	        redirectTo: '/',
			      	      });
			      	  }]);
			
			app.run(['$rootScope','$location', '$routeParams', function($rootScope, $location, $routeParams) {
			    $rootScope.$on('$routeChangeSuccess', function(e, current, pre) {
			    	
			    	$(function() {
					    FastClick.attach(document.body);
					    $("#createbtn").removeClass('active');
						$("#blackbookbtn").addClass('active');
						
				      	$('.user-alias').html(getUserAlias());
				      	
									$('.dropdown')
							  		.dropdown({
							  		    //dropdown settings
						  		    })
							  		;
								 
									$('.checkbox')
							  		.checkbox();
						 	$('.action-button,#invite-modal-open').off('click').on('click',function(){
							 		var tmpData = $(this).data();
							 		console.log('tmpData',tmpData);
							 		
							 	
							 		if(typeof tmpData.modalid !== 'undefined'){
							 			
							 			$('#'+tmpData.modalid).transition('scale')
							 			;
							 			$('#'+tmpData.hidecontentids).transition('scale')
							 			;			
							 		}
							 	});
							 	$("#clear-blackbook-button").on("click",function(){
										
										oblivious.blackbookClear();
										$("html, body").animate({ scrollTop: 0 }, "slow");
										location.reload(true);
								});

					});
			    	
			      console.log('Current route name: ' + $location.path());
			      	switch($location.path()){
			      	case "/":
			      		Entries = [];
			      		indexRouteDOMLoaded();
			      		break;
		      		default:
		      			$("#blackbook").hide();
		      			break;
			      	}
			      
			    });

			  }]);
			</script>
			
			<script>
			
			document.addEventListener("deviceready", onDeviceReady, false);
			function onDeviceReady() {
				$(document).off('click').on('click', 'img.processed-entry-image', function(event) {
			        event.preventDefault();
			        var tmpSRC = $(this).attr('src');
			        
			        var canvas = canvas = document.createElement('canvas');
			    	canvas.width = GhostPixels.dimensions.width;
			    	canvas.height = GhostPixels.dimensions.height;
			    	var img = new Image();
			        img.onload = function() {
			            var ctx = canvas.getContext('2d');
			            ctx.canvas.width = img.width;
			            ctx.canvas.height = img.height;
			            ctx.drawImage(img, 0, 0);
			            
			            window.canvas2ImagePlugin.saveImageDataToLibrary(
				                function(msg){
				                    alert('File has been saved to gallery.');
				                },
				                function(err){
				                    alert('File could not be saved to gallery.');
				                },
				                canvas
				            );
			        };
			        img.src = tmpSRC;
			        
			    });
// 				var ref = window.open('https://web.hazedaily.com','_blank','toolbar=no');
				
			}; //end onDeviceReady
			
			</script>
	</body>
</html>