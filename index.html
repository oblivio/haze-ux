<!DOCTYPE HTML>
<html>
	<head>
		<title>HAZE</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/> 
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<link rel="stylesheet" type="text/css" href="semanticui/dist/semantic.min.css">
		
		<style>
		@font-face {
		  font-family: 'Monoton';
		  font-style: normal;
		  font-weight: 400;
		  src: local('Monoton'), local('Monoton-Regular'), url(assets/fonts/monoton.woff2) format('woff2');
		}
		.has-changed{
			border: 0.25em solid red !important;
		}
		#main{
			margin-top:5em;
			padding-top:1em;
		}
		#logo{
			font-family: "Monoton",cursive;
			font-size: 1.5em;
			letter-spacing: 1px;
		}
		
		
.slide.ng-enter,
.slide.ng-leave {
    -webkit-transition: all 1s ease;
    transition: all 1s ease;
}
.slide.ng-enter {
    left: 100%;
}
.slide.ng-enter-active {
    left: 0;
}
.slide.ng-leave {
    left: 0;
}
.slide.ng-leave-active {
    left: -100%;
}
		</style>
	</head>
	<body ng-app="hazeApp">
		<!-- Wrapper-->
			<div id="wrapper">

				<!-- Nav -->
					
					<nav onclick="" class="ui three item fixed green pointing menu">
					  	<a id="logo" class="item">
					  	
					  	HAZE
					  	</a>
						<a onclick="$('.active.item').removeClass('active');$(this).addClass('active')" id="blackbookbtn" href="#/" class=" item"><div class="ui  black basic  icon button"><i class="comments outline icon"></i></div></a>
						<a onclick="$('.active.item').removeClass('active');$(this).addClass('active')" id="createbtn" href="#/create" class="item"><div class="ui  black basic icon button"><i class="add icon"></i></div></a>
					</nav>
					
				<!-- Main -->
					<div id="main" class="">
						
						<!-- content-section -->
						<div class="slide" ng-view></div>
						<!-- /content-section -->
						
<article id="blackbook" style="display:none;" class="ui stacked segment">
<div  class="ui card ">
		  <div class="content">
 		      <div class="right floated">
		  		</div>
		    <div class="header user-alias">
		    					
		    </div>
		    <div class="meta">
		      <span class="category">Blackbook </span>
		    </div>
		    <div class="description">
		      <a onclick="bbcheck()" class="ui right floated icon green button"><i class="refresh icon"></i></a>
		    </div>
		  </div>
		  <div class="extra content">
		    <div class="right floated author">
		    	<div id="" class="ui right labeled left icon mini input">
				  <i class="tags icon"></i>
				  <input id="user-alias-input" placeholder="Enter Alias" type="text">
				  <a class="ui tag label" onclick="setUserAlias()">
				    Alias
				  </a>
				</div>
					  <a href="#/processinvite" class="ui orange fluid button" id="invite-modal-open">Have an invite?</a>
				
		    </div>
		    
		  </div>
		  
		</div>
	<hr />
	<div  id="blackbook-contents" class="ui cards">
							
			</div>
			<br />
			<br />
			  <a  class="ui red bottom attached basic button" id="clear-blackbook-button">clear blackbook</a>
					
</article>
						
									
					</div>

				<!-- Footer -->
					<div id="footer">
						&nbsp;
					</div>

			</div>

		<!-- Scripts -->
			
		<script src="phonegap.js"></script>
				
		<!-- Optional -->
		
			<script src="assets/js/jquery.min.js"></script>
			<script src="semanticui/dist/semantic.min.js"></script>	
			<script src="js/vendor/fastclick.js"></script>
			
		
			
			<script src="js/vendor/angular.min.js"></script>
			<script src="js/vendor/angular-route.min.js"></script>
			
			<script src="js/vendor/bindonce.js"></script>
			<script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
	        <script src="js/vendor/load-image.all.min.js"></script>
	        <script src="js/vendor/sjcl.js?#"></script>
	        <script src="js/ghostpixels/vendor/rsvp.min.js?#"></script>
	        <script src="js/ghostpixels/ghostpixels.js?#"></script>
			<script src="js/vendor/base64.js?#"></script>
			<script src="js/vendor/rawdeflate.js?#"></script>
			<script src="js/vendor/rawinflate.js?#"></script>      
	    	<script src="js/identicon.js/pnglib.js?#"></script>
			<script src="js/identicon.js/identicon.js?#"></script>
	    	<script src="js/vendor/moment.js"></script>
	    	
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			
			<script src="js/haze.js"></script>
			
			
			
			<script>
				//localstorage shit
				function bbcheck(){
							
							var currEntries = [];
					    	var newCommentCount = {};
					    	
					    	//api.blackbook({blackbookdata:Entries});
					    	
							$.post( "https://www.hazedaily.com/api/blackbook/", {blackbookdata:Entries})
							  .done(function( data ) {
							    var hasChanged = [];
							    	data = JSON.parse(data);
							    	console.log('data from bb check',data);
							    	
								    $.each(data,function(i,obj){
								    	//obj[0] is the entry
								    	console.log('obj',obj,obj.length);
								    	if(typeof obj.changed === 'undefined')
								    		return true; //skip
								    		
								    		
								    		if(obj.changed){
								    			var tmp = {
								    					'entryid':obj.entryid,
								    					'category':obj.category,
								    					'visiblename':obj.entryid
								    			};
								    			hasChanged.push(tmp);

								    		}
								    		currEntries.push(obj);	
								    		
								    });
								    
								    
								    
								    $.each(localEntries,function(ii,encodedentry){
										var tmpRaw = String(encodedentry).split(":");
										var tmpID = tmpRaw[0];
										var tmpCat = tmpRaw[1];
										
										var foundEntry = false;
										$.each(currEntries,function(jj,obj){
									    	//String(tmpEntry.entryid+ ":" + tmpEntry.category)
											console.log('obj-checkit',obj);
											if(obj.entryid == tmpID && obj.category == tmpCat){
												foundEntry = true;
												return false;
											}
											
									    });
										if(!foundEntry){
											console.log('entry no longer exists!');
									    	oblivious.blackbookSet('commentcount',tmpID +":"+tmpCat ,-1);
											location.reload(true);
										}else{
											console.log('entry still exists amigo');
										}
									});
								    //bb_hasChanged = hasChanged;
							    	console.log('hasChanged',hasChanged);
									
							  }, "json");
						};	
				function getEntryAlias(eID,eCat){
					var myAliasData = oblivious.blackbookGet('aliases');
					//oblivious.blackbookSet('aliases',entryID+":"+cat,String(newAlias));
					var alias = eID;
					$.each(myAliasData,function(i,tmpAlias){
						if(typeof tmpAlias !== 'undefined' && typeof tmpAlias.value !== 'undefined'){
							
							if(tmpAlias.key == String(eID+":"+eCat) && String(tmpAlias.value).length > 0){
								alias = tmpAlias.value;
								console.log('alias',alias);
								return false;
							}
								
						}
					});
					return alias;
				}
				function getIdenticon(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				function setUserAlias(){
					var newAlias = $('#user-alias-input').val();
					console.log('newAlias',newAlias);
 					oblivious.blackbookSet('aliases','me',String(newAlias));
					location.reload(true);
				};
				function setEntryAlias(entryid,category){
					var newAlias = $('#entry-alias-'+entryid+'-'+category).val();
					console.log('newAlias',newAlias);
 					oblivious.blackbookSet('aliases',entryid+":"+category,String(newAlias));
					location.reload(true);
				};
				//
				function createCardHTML(entry){
var cardHTML = "<div class='ui card' id='"+entry.category+"-"+entry.entryid+"' > "+
   			    	"<button style='display:none;' class='ui icon top attached labeled red button'><i class='delete icon'></i>remove</button>" +
				  "<div class='content'>"+
	      			"<div class='right floated'>"+
	      			"<img class='ui avatar image' src='"+getIdenticon(entry.entryid)+"'>"+
  					"</div>"+
    				"<div class='header'>"+entry.visiblename+"</div>"+
			    	"<div class='meta'>"+
			    	  "<span class='category'>haze entry</span>"+
			    	"</div>"+
				    "<div class='description'>"+
				      "<p></p>"+
				    "</div>"+
				  "</div>"+
				  "<div class='extra content'>"+
				    "<div class='right floated author'>"+
				    	"<div id='' class='ui right labeled left icon mini input'>"+
						  "<i class='tags icon'></i>"+
						  "<input id='entry-alias-"+entry.entryid+"-"+entry.category+"' placeholder='Enter Alias' type='text'>"+
						  "<a class='ui tag label' onclick='setEntryAlias(\""+entry.entryid+"\",\""+entry.category+"\")'>"+
						    "Alias"+
						  "</a>"+
						"</div>"+
						"<a href='#/invite/"+entry.category+"/"+entry.entryid+"' class='ui fluid button teal'>invite</a>"+
				    "</div>"+
				  "</div>"+
				"<a href='#/view/"+entry.category+"/"+entry.entryid+"' class='ui icon labeled bottom attached green button '><i class='eye icon'></i>view</a>"+
			"</div>";
			console.log('cardHTML',cardHTML);
			return cardHTML;
				};
				function getUserAlias(){
					var alias = '(Anonymous)';
					var myAliasData = oblivious.blackbookGet('aliases');
					//oblivious.blackbookSet('aliases',entryID+":"+cat,String(newAlias));

					$.each(myAliasData,function(i,tmpAlias){
						if(typeof tmpAlias !== 'undefined' && typeof tmpAlias.value !== 'undefined'){
							
							if(tmpAlias.key == 'me' && String(tmpAlias.value).length > 0){
								alias = tmpAlias.value;
								return false;
							}
								
						}
					});
					return alias;
				}
				function getBlackbookEntries(){
					var TmpEntries = [];
					var localEntries = [];
					var localCommCount = oblivious.blackbookGet('commentcount');
					console.log('bbcheck!');
					$("#blackbook-contents").html('');
					var tmpHTML = '';
					$.each(localCommCount,function(j,cObj){						
							var tmpEntry = {
									'category':'',
									'entryid':'',
									'visiblename':'',
									'commentcount':'',
							};
							var tmpRaw = String(cObj.key).split(":");
							var tmpID = tmpRaw[0];
							var tmpCat = tmpRaw[1];
							tmpEntry.entryid = tmpID;
							tmpEntry.visiblename = getEntryAlias(tmpID,tmpCat);	
							tmpEntry.category = tmpCat;

							
							if(String(cObj.key) === String(tmpEntry.entryid+ ":" + tmpEntry.category) ){
								tmpEntry.commentcount = cObj.value;
							}
						
						if(typeof tmpEntry.category != 'undefined' && typeof tmpEntry.entryid != 'undefined' && typeof tmpEntry.commentcount != 'undefined' && tmpEntry.commentcount != -1 && tmpEntry.commentcount != '-1'){								
							TmpEntries.push(tmpEntry);
							localEntries.push( String(tmpEntry.entryid+ ":" + tmpEntry.category) );
							tmpHTML += createCardHTML(tmpEntry) ;
						}
							
					});
					$("#blackbook-contents").html( tmpHTML );
					
					return TmpEntries;
				}
				var Entries = [];
			</script>
			
			<script>
		
		</script>
			
			<script>
			
			var app = angular.module('hazeApp',  ['ngRoute']);
			
			app.controller('HazeViewCtrl',function($scope,$location,$interval,$routeParams){
				
				
				$scope.getEntryAlias = function(eID,eCat){
					
					var myAliasData = oblivious.blackbookGet('aliases');
					//oblivious.blackbookSet('aliases',entryID+":"+cat,String(newAlias));
					var alias = eID;
					
					$.each(myAliasData,function(i,tmpAlias){
						if(typeof tmpAlias !== 'undefined' && typeof tmpAlias.value !== 'undefined'){
							console.log('tmpAlias',tmpAlias);
							if(tmpAlias.key == String(eID+":"+eCat) && String(tmpAlias.value).length > 0){
								alias = tmpAlias.value;
								console.log('alias',alias);
							}
								
						}
					});
					return alias;
				};
				
				$scope.entryid = $routeParams.eid;
				$scope.category = $routeParams.category;
				$scope.entryContents = false;
				$scope.entryPassword = '';

				$scope.hasChanged = [];
				
				$scope.currentComment = '';
				$scope.currentCommentImg = '';
				
				
				$scope.entryid = $routeParams.eid;
//					$scope.category = $routeParams.category;
//					$scope.entryContents = false;
//					$scope.entryPassword = '';
				$scope.getEntry = function(){
					var earlyExit = false;
					switch($location.path()){
					
				      case "/":
				      case "/create":
				    	 earlyExit = true;
				    	 break;
				      }
						if(earlyExit){
							return false;
						}
						oblivious.getEntry($scope.entryid,$scope.category,function(){
							console.log('this @ getEntry',this);
							var data = this;
							var eContents = false;
							if(data[1] == "Paste does not exist, has expired or has been deleted."){
								oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category ,-1);
								console.log('paste no existe',data[1]);
								$location.path('/');
							}else{
								if(data[0].meta.krypi == "1"){
									var pwd = $scope.entryPassword;
									if(pwd){
										eContents = oblivious._processGetEntry(data,$scope.entryid,pwd);
										
									}else{
										$location.path('/');
									}
							    }else{
							    	eContents = oblivious._processGetEntry(data,$scope.entryid,'');
							    }
							}
							$scope.$apply(function() {
						    	$scope.entryContents = eContents.reverse();
						    });
							
						});
						
			};
			
			window.setInterval(function(){
					$scope.getEntry();
				},30000); //check every 30s
				
				$scope.hasPhoto = function(img){
					if(img == ''){
						return false;
					}else{
						return true;
					}
				};
				$scope.showImage = function(e){
					//view-image-modal
					//modal-img-src
					
					$("#modal-img-src").attr('src','');
					$("#modal-img-src").attr('src',e.image);
					
					$("#view-image-modal").modal('show');
					
				};
				$scope.sendComment = function(){
					$scope.currentComment = $("#comment-text").val();
					
					if($scope.currentComment == '' && $scope.currentCommentImg == ''){
						console.log('no comment entered');
					}else{
						console.log('comment entered!');
						var d ={ comment:String($scope.currentComment),
					             imgdata:'',
					             userkey:'',
					             containsimage:0,
					             nickname:''
						     };
						if($scope.currentCommentImg != ''){
							d.imgdata = $scope.currentCommentImg;
							d.containsimage = 1;
						}
						console.log('d',d);
						oblivious.addEntryComment($scope.entryid, 
								$scope.category,
								d,function(){
								location.reload(true);
						});
					}
				};
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				$scope.toggleComment = function(){
					console.log('toggling comment');
				
					$("#add-comment-form").transition('scale');
				};
				
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
					// Run after view loaded.
					$("#blackbook").hide();
					$('.dropdown')
			  		.dropdown({
			  		    //dropdown settings
		  		    })
			  		;
					oblivious._onchange('addimage-input-comment',function(){
						var imgData = String(this);
						$scope.$apply(function() {
							$scope.currentCommentImg = imgData;
						});
					});
					
					$('.checkbox')
			  		.checkbox();
					oblivious.getEntry($scope.entryid ,$scope.category,function(){
						console.log('this @ getEntry',this);
						var data = this;
						var eContents,pwd;
						if(data[1] == "Paste does not exist, has expired or has been deleted."){
							oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category ,-1);
							$location.path('/');
						}else{
							if(data[0].meta.krypi == "1"){
								pwd = prompt("Please enter password to decrypt");
								if(pwd){
									eContents = oblivious._processGetEntry(data,$scope.entryid ,pwd);
									
								}else{
									
									$location.path('/');
								}
						    }else{
						    	eContents = oblivious._processGetEntry(data,$scope.entryid,'');
						    	
						    }
							$scope.$apply(function() {

								$scope.entryContents = eContents.reverse(); //reverse order
								$scope.entryPassword = pwd;
								
								console.log('eContents',eContents,$scope.entryContents );
								
				    			oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category , $scope.entryContents.length);
								
								if(eContents[0].image != ""){

									$("#main-img").attr('src',eContents[0].image);	
									$("#main-img").fadeIn();

								}
								
								$("#main-message").text(eContents[0].text);
								
								
							});
						}
					});
				});
			});
			app.config(function ($httpProvider) {
			  $httpProvider.defaults.headers.common = {};
			  $httpProvider.defaults.headers.post = {};
			  $httpProvider.defaults.headers.put = {};
			  $httpProvider.defaults.headers.patch = {};
			});
			app.factory('api', function($http){
				var bb_hasChanged = [];
				var observerCallbacks = [];
				var notifyObservers = function(){
					angular.forEach(observerCallbacks, function(callback){
					      callback();
					    });
				};
			    return {
			    	registerObserverCallback: function(callback){
						observerCallbacks.push(callback);
					},
			    	bbhaschanged:function(){return bb_hasChanged},
			    	checkblackbook: function(){
			        
						bbcheck();
			        }
			    }               
			});
			app.controller('BlackbookCtrl',function($scope,$location,$timeout,$interval,$routeParams,api){
				
				
				
			});
			
			app.controller('CreateCtrl',function($scope,$location,$routeParams){
				$("#blackbookbtn").removeClass('active');
				$("#createbtn").addClass('active');
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
					$("#blackbook").hide();
			    	  
					oblivious._onchange('addimage-input',function(){
						var imgData = String(this);
						$scope.$apply(function() {
							$scope.newentry.image = imgData;
						});
					});
					// Run after view loaded.
					$('.dropdown')
			  		.dropdown({
			  		    //dropdown settings
		  		    })
			  		;
				 
					$('.checkbox')
			  		.checkbox();
					
					
					$('#cryptotoggle').on("change",function(){
						
						if($(this).checkbox('is checked')){
							console.log('enable crypto');	
							oblivious._enableClientCrypto();
						}else{
							console.log('disable crypto');
							oblivious._disableClientCrypto();
						}
					});
					
					$("#metadata_entry").on("change",function(){
						$("#metadata_preview").show();
						if($(this).val() == '')
							$("#metadata_preview").hide();
						
						var tmpJSON = $(this).val();
						try{
							tmpJSON = JSON.parse(tmpJSON);
							var tmpMeta = {};
							for (var attrname in tmpJSON) { 
								tmpMeta[attrname] = tmpJSON[attrname]; 
							}
							$scope.$apply(function() {
								$scope.newentry.meta = tmpMeta;
							});
							$("#metadata_preview").val( JSON.stringify(tmpJSON,null,2) );
						}catch(e){
							console.log('not valid JSON');
						}
						
					});	
				});
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
				$scope.newentry =  {
						'image':'',
						'clientsidecrypto':'',
						'password':'',
						'message':'',
						'expiration':'',
						'metadata':'',
					};
				
				$scope.submitNewEntry = function(){
					var entryDetails = {
						'image':'',
						'clientsidecrypto':'',
						'password':'',
						'message':'',
						'expiration':'',
						'metadata':'',
						'meta':'',
						'category':'public',
						'containsimage':0
					};
					entryDetails.clientsidecrypto = $('#cryptotoggle').checkbox('is checked');
					entryDetails.password = $('#entry-password').val();
					entryDetails.message = $("#entry-text").val();
					entryDetails.expiration = $("#entry-expiration").val();
					entryDetails.metadata = $("#metadata_entry").val();
					entryDetails.image = $scope.newentry.image;
					if(entryDetails.image != ''){
						entryDetails.containsimage = 1;
					}
					console.log('entry-details',entryDetails);
					
					var d ={ data:String(entryDetails.message),
				             expire:entryDetails.expiration,
				             opendiscussion: 1,
				             category:entryDetails.category,
				             userkey:entryDetails.password,
				             imgdata:entryDetails.image,
				             containsimage:entryDetails.containsimage
					     };
					for (var attrname in $scope.newentry.meta) { d[attrname] = $scope.newentry.meta[attrname]; }

					if(entryDetails.password != ''){
						//krypi-password
						//(newEntry,category,userKey,img_data){
						d.userkey = entryDetails.password;
					}
					if(entryDetails.image != ''){
						d.imgdata = entryDetails.image;
						d.containsimage = 1;
					}
					console.log('d',d);
					if(d.imgdata || d.userkey){
						console.log('krypi entry');
						oblivious.addKrypiEntry(d,function(){
							console.log('added!');
						});
					}else{
						console.log('regular entry');
						oblivious.addEntry(d,function(){
							console.log('added!')
						});
					}
					$('#addentryform')[0].reset();
					$("html, body").animate({ scrollTop: 0 }, "slow");
					
				};
			});
			app.controller('HazeInviteViewCtrl',function($scope,$location,$routeParams){
				
				
				
				$scope.entryid = $routeParams.eid;
				$scope.category = $routeParams.category;
				
				$scope.generateInvite = function(){
					if($("#invite-pwd").val() != ''){
							oblivious._generateInvite($scope.entryid ,$scope.category);
							//clear fields
							$("#invite-pwd").val('');
							$("#invite-img-wrapper").fadeIn();
					}
				};
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
					$("#blackbook").hide();
				});
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
			});
			app.controller('HazeProcessInviteViewCtrl',function($scope,$location,$routeParams){

				$scope.process = function(){
					oblivious._processInvite('#invite-status');
				};
				$scope.$on('$viewContentLoaded', function(){
// 					$("#main-dimmer").removeClass('active');
$("#blackbook").hide();
					document.getElementById('decode-input').onchange = function(input) {
						var file    = document.getElementById('decode-input').files[0];
						if ( file ) {
					        var FR= new FileReader();
					        FR.onload = function(e) {
					        	var password = prompt('Enter password (leave empty if none)');
					        	
								GhostPixels.decode(password,e.target.result).then(function(decodedMessage){
									
									$("#encodedinvite-input").val(decodedMessage);
									$("#encodedinvite-input").data('pwd',password);
									
					        	});
					        	
					        };       
					        FR.readAsDataURL( file );
					    }
					};
					$("#submit-invite-button").on("click",function(){
						oblivious._processInvite('#invite-status');
							$("#inviteform")[0].reset();
					});
					
				});
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
			});
			app.directive('loading',   ['$http' ,function ($http)
			                             {
		        return {
		            restrict: 'A',
		            link: function (scope, elm, attrs)
		            {
		                scope.isLoading = function () {
		                    return $http.pendingRequests.length > 0;
		                };

		                scope.$watch(scope.isLoading, function (v)
		                {
		                    if(v){
		                        elm.show();
		                    }else{
		                        elm.hide();
		                    }
		                });
		            }
		        };

		    }]);
			app.config(['$routeProvider',
			      	  function($routeProvider) {
			      	    $routeProvider.
			      	      when('/create', {
			      		        templateUrl: 'templates/create.html',
			      		        controller: 'CreateCtrl'
			      	      }).
			      	    when('/view/:category/:eid', {
		      		        templateUrl: 'templates/view.html',
		      		        controller: 'HazeViewCtrl'
		      	      	}).
		      	      when('/invite/:category/:eid', {
		      		        templateUrl: 'templates/invite.html',
		      		        controller: 'HazeInviteViewCtrl'
		      	      	}).
		      	      when('/processinvite', {
		      		        templateUrl: 'templates/processinvite.html',
		      		        controller: 'HazeProcessInviteViewCtrl'
		      	      	}).
			      	      otherwise({
			      	        redirectTo: '/'
			      	      });
			      	  }]);
			
			app.run(['$rootScope','$location', '$routeParams', function($rootScope, $location, $routeParams) {
			    $rootScope.$on('$routeChangeSuccess', function(e, current, pre) {
			    	
			    	$(function() {
					    FastClick.attach(document.body);
					    $("#createbtn").removeClass('active');
						$("#blackbookbtn").addClass('active');
						
						Entries = getBlackbookEntries();	
				      	$('.user-alias').html(getUserAlias());
				      	
									$('.dropdown')
							  		.dropdown({
							  		    //dropdown settings
						  		    })
							  		;
								 
									$('.checkbox')
							  		.checkbox();
						 	$('.action-button,#invite-modal-open').off('click').on('click',function(){
							 		var tmpData = $(this).data();
							 		console.log('tmpData',tmpData);
							 		
							 	
							 		if(typeof tmpData.modalid !== 'undefined'){
							 			
							 			$('#'+tmpData.modalid).transition('scale')
							 			;
							 			$('#'+tmpData.hidecontentids).transition('scale')
							 			;			
							 		}
							 	});
							 	$("#clear-blackbook-button").on("click",function(){
										
										oblivious.blackbookClear();
										$("html, body").animate({ scrollTop: 0 }, "slow");
										location.reload(true);
								});

					});
			      console.log('Current route name: ' + $location.path());
			      	switch($location.path()){
			      	case "/":
			      		$("#blackbook").show();
			      		break;
		      		default:
		      			$("#blackbook").hide();
		      			break;
			      	}
			      
			    });

			  }]);
			</script>
			
			<script>
			
			document.addEventListener("deviceready", onDeviceReady, false);
			function onDeviceReady() {
				$(document).on('click', 'img.processed-entry-image', function(event) {
			        event.preventDefault();
			        var tmpSRC = $(this).attr('src');
			        
			        var canvas = canvas = document.createElement('canvas');
			    	canvas.width = GhostPixels.dimensions.width;
			    	canvas.height = GhostPixels.dimensions.height;
			    	var img = new Image();
			        img.onload = function() {
			            var ctx = canvas.getContext('2d');
			            ctx.canvas.width = img.width;
			            ctx.canvas.height = img.height;
			            ctx.drawImage(img, 0, 0);
			            
			            window.canvas2ImagePlugin.saveImageDataToLibrary(
				                function(msg){
				                    alert('File has been saved to gallery.');
				                },
				                function(err){
				                    alert('File could not be saved to gallery.');
				                },
				                canvas
				            );
			        };
			        img.src = tmpSRC;
			        
			    });
			}; //end onDeviceReady
			
			</script>
	</body>
</html>