<!DOCTYPE HTML>
<html>
	<head>
		<title>HAZE</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/> 
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
		
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<link rel="stylesheet" type="text/css" href="semanticui/dist/semantic.min.css">
		
		<style>
		@font-face {
		  font-family: 'Monoton';
		  font-style: normal;
		  font-weight: 400;
		  src: local('Monoton'), local('Monoton-Regular'), url(assets/fonts/monoton.woff2) format('woff2');
		}
		.has-changed{
			border: 1em solid red !important;
		}
		#main{
			margin-top:5em;
			padding-top:1em;
		}
		#logo{
			font-family: "Monoton",cursive;
			font-size: 1.5em;
			letter-spacing: 1px;
		}
		</style>
	</head>
	<body ng-app="hazeApp">
		<!-- Wrapper-->
			<div id="wrapper">

				<!-- Nav -->
					
					<nav class="ui three item fixed green pointing menu">
					  	<a id="logo" class="item">
					  	
					  	HAZE
					  	</a>
						<a id="blackbookbtn" href="#/blackbook" class="item"><div class="ui basic green  icon button"><i class="comments outline icon"></i></div></a>
						<a id="createbtn" href="#/create" class="item"><div class="ui basic green icon button"><i class="add icon"></i></div></a>
					</nav>
					
				<!-- Main -->
					<div id="main" class="">

						<!-- content-section -->
						<div ng-view></div>
						<!-- /content-section -->

					</div>

				<!-- Footer -->
					<div id="footer">
						&nbsp;
					</div>

			</div>

		<!-- Scripts -->
			
		<script src="phonegap.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.3.0/js/md5.min.js"></script>
		
		<!-- Optional -->
		
			<script src="assets/js/jquery.min.js"></script>
			<script src="semanticui/dist/semantic.min.js"></script>	
		
			<script src="js/vendor/angular.min.js"></script>
			<script src="js/vendor/angular-route.min.js"></script>
			<script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
	        <script src="js/vendor/load-image.all.min.js"></script>
	        <script src="js/vendor/sjcl.js?#"></script>
	        <script src="js/ghostpixels/vendor/rsvp.min.js?#"></script>
	        <script src="js/ghostpixels/ghostpixels.js?#"></script>
			<script src="js/vendor/base64.js?#"></script>
			<script src="js/vendor/rawdeflate.js?#"></script>
			<script src="js/vendor/rawinflate.js?#"></script>      
	    	<script src="js/identicon.js/pnglib.js?#"></script>
			<script src="js/identicon.js/identicon.js?#"></script>
	    	<script src="js/vendor/moment.js"></script>
	    	
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			
			<script src="js/haze.js"></script>
			
			<script>
			
			var app = angular.module('hazeApp',  ['ngRoute']);
			
			app.controller('HazeViewCtrl',function($scope,$location,$routeParams){
				
				
				
				$scope.entryid = $routeParams.eid;
				$scope.category = $routeParams.category;
				$scope.entryContents = false;
				$scope.entryPassword = '';

				$scope.hasChanged = [];
				
				$scope.currentComment = '';
				$scope.currentCommentImg = '';
				
				
				
				//blackbook check
				var bbcheck = function(){
					console.log('bbcheck!');
					var Entries =[];
					var localEntries = [];
					var localMeta = oblivious.blackbookGet('meta');
					var localCommCount = oblivious.blackbookGet('commentcount');
					$.each(localMeta,function(i,obj){
						var tmpEntry = {
								'category':'',
								'entryid':'',
								'visiblename':'',
								'commentcount':'',
						};
						var tmpRaw = String(obj.key).split(":");
						var tmpID = tmpRaw[0];
						var tmpCat = tmpRaw[1];
						
						tmpEntry.entryid = tmpID;
						tmpEntry.visiblename = tmpID;
						
						tmpEntry.category = tmpCat;

						console.log('tmpEntry',tmpEntry);
						
						$.each(localCommCount,function(j,cObj){
							console.log('cObj',cObj,String(cObj.key) === String(tmpEntry.entryid+ ":" + tmpEntry.category) );
							
							if(String(cObj.key) === String(tmpEntry.entryid+ ":" + tmpEntry.category) ){
								tmpEntry.commentcount = cObj.value;
								return false;
							}
						});
						
						console.log('que ostia?',tmpEntry);
						if(typeof tmpEntry.category != 'undefined' && typeof tmpEntry.entryid != 'undefined' && typeof tmpEntry.commentcount != 'undefined' && tmpEntry.commentcount != -1 && tmpEntry.commentcount != '-1'){
								
							localEntries.push( String(tmpEntry.entryid+ ":" + tmpEntry.category) );
							Entries.push(tmpEntry);
							
						}

							
					});
					if(Entries.length == 0)
						return false;
					console.log('Entries',Entries);
					var currEntries = [];

			    	var newCommentCount = {};
			    	
					$.post( "https://www.hazedaily.com/api/blackbook/", {blackbookdata:Entries})
					  .done(function( data ) {
					    var hasChanged = [];
					    	data = JSON.parse(data);
					    	console.log('data from bb check',data);
					    	
						    $.each(data,function(i,obj){
						    	//obj[0] is the entry
						    	console.log('obj',obj,obj.length);
						    	if(typeof obj.changed === 'undefined')
						    		return true; //skip
						    		
						    		
						    		if(obj.changed){
						    			var tmp = {
						    					'entryid':obj.entryid,
						    					'category':obj.category,
						    					'visiblename':obj.entryid
						    			};
						    			hasChanged.push(tmp);

						    		}
						    		currEntries.push(obj);	
						    		
						    });
						    
						    $scope.$apply(function() {
						    	$scope.hasChanged = hasChanged;
// 						    	$scope.loadBlackbook();
						    });
						    
							//if @ blackbook
							if($location.path() == '/blackbook'){
								
							}else{
// 								$scope.entryid = $routeParams.eid;
// 								$scope.category = $routeParams.category;
// 								$scope.entryContents = false;
// 								$scope.entryPassword = '';
								oblivious.getEntry($scope.entryid,$scope.category,function(){
									console.log('this @ getEntry',this);
									var data = this;
									var eContents = false;
									if(data[1] == "Paste does not exist, has expired or has been deleted."){
										oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category ,-1);
										console.log('paste no existe',data[1]);
										$location.path('/blackbook');
									}else{
										if(data[0].meta.krypi == "1"){
											var pwd = $scope.entryPassword;
											if(pwd){
												eContents = oblivious._processGetEntry(data,$scope.entryid,pwd);
												
											}else{
												$location.path('/blackbook');
											}
									    }else{
									    	eContents = oblivious._processGetEntry(data,$scope.entryid,'');
									    }
									}
									$scope.$apply(function() {
								    	$scope.entryContents = eContents.reverse();
								    	console.log('new comment! yay!');
								    });
									
								});
							}
							
					  }, "json");
				};
				bbcheck();
				window.setInterval(bbcheck,30000); //check every 30s
				
				
				
				
				
				$scope.hasPhoto = function(img){
					if(img == ''){
						return false;
					}else{
						return true;
					}
				};
				$scope.showImage = function(e){
					//view-image-modal
					//modal-img-src
					
					$("#modal-img-src").attr('src','');
					$("#modal-img-src").attr('src',e.image);
					
					$("#view-image-modal").modal('show');
					
				};
				$scope.sendComment = function(){
					$scope.currentComment = $("#comment-text").val();
					
					if($scope.currentComment == '' && $scope.currentCommentImg == ''){
						console.log('no comment entered');
					}else{
						console.log('comment entered!');
						var d ={ comment:String($scope.currentComment),
					             imgdata:'',
					             userkey:'',
					             containsimage:0,
					             nickname:''
						     };
						if($scope.currentCommentImg != ''){
							d.imgdata = $scope.currentCommentImg;
							d.containsimage = 1;
						}
						console.log('d',d);
						oblivious.addEntryComment($scope.entryid, 
								$scope.category,
								d,function(){
								location.reload(true);
						});
					}
				};
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				$scope.toggleComment = function(){
					console.log('toggling comment');
				
					$("#add-comment-form").transition('scale');
				};
				
				$scope.$on('$viewContentLoaded', function(){
					// Run after view loaded.
					$('.dropdown')
			  		.dropdown({
			  		    //dropdown settings
		  		    })
			  		;
					oblivious._onchange('addimage-input-comment',function(){
						var imgData = String(this);
						$scope.$apply(function() {
							$scope.currentCommentImg = imgData;
						});
					});
					
					$('.checkbox')
			  		.checkbox();
					oblivious.getEntry($scope.entryid ,$scope.category,function(){
						console.log('this @ getEntry',this);
						var data = this;
						var eContents,pwd;
						if(data[1] == "Paste does not exist, has expired or has been deleted."){
							oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category ,-1);
							$location.path('/blackbook');
						}else{
							if(data[0].meta.krypi == "1"){
								pwd = prompt("Please enter password to decrypt");
								if(pwd){
									eContents = oblivious._processGetEntry(data,$scope.entryid ,pwd);
									
								}else{
									
									$location.path('/blackbook');
								}
						    }else{
						    	eContents = oblivious._processGetEntry(data,$scope.entryid,'');
						    	
						    }
							$scope.$apply(function() {

								$scope.entryContents = eContents.reverse(); //reverse order
								$scope.entryPassword = pwd;
								
								console.log('eContents',eContents,$scope.entryContents );
								
				    			oblivious.blackbookSet('commentcount',$scope.entryid +":"+$scope.category , $scope.entryContents.length);
								
								if(eContents[0].image != ""){

									$("#main-img").attr('src',eContents[0].image);	
									$("#main-img").fadeIn();

								}
								
								$("#main-message").text(eContents[0].text);
								
								
							});
						}
					});
				});
			});
			app.controller('BlackbookCtrl',function($scope,$location,$routeParams){
				
				
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
				$scope.getEntryClassName = function(e){
					console.log('$scope.hasChanged',$scope.hasChanged,e);
					var className = "ui card haze-entry";
					$.each($scope.hasChanged,function(i,tmpObj){
						if(e.entryid == tmpObj.entryid && e.category == tmpObj.category){
							className += " has-changed ";
							console.log('esto paso?',className);
							return false; //exit loop
						}
					});
					console.log('className?',className);
					return className;
				};

				$scope.hasChanged = [];
				$scope.entries = [];
				
				$scope.setEntryAlias = function(entryID,cat){
					var newAlias = $('#entry-alias-'+entryID).val();
 					oblivious.blackbookSet('aliases',entryID+":"+cat,String(newAlias));
					location.reload(true);
				};
				
				$scope.setUserAlias = function(){
					var alias = $("#user-alias-input").val();
					if(alias.length > 0)
						oblivious.blackbookSet('aliases','me',alias);
					
					console.log('new user alias - ',alias,oblivious.blackbookGet('aliases','me'));
					location.reload(true);
				};
				$scope.getUserAlias = function(){
					var alias = '(Anonymous)';
					var myAliasData = oblivious.blackbookGet('aliases','me');
					if(typeof myAliasData[0] !== 'undefined' && typeof myAliasData[0].value !== 'undefined'){

						if(String(myAliasData[0].value).length > 0){
							alias = myAliasData[0].value;
						}
						console.log('alias',alias);
						return alias;	
					}
				};
				$scope.user_alias = $scope.getUserAlias();
				$scope.user_identicon = '';
				$scope.getBlackbookEntries = function(){

					var Entries =[];
					var localMeta = oblivious.blackbookGet('meta');
					
					var localAliases = oblivious.blackbookGet('aliases');

					var localCommCount = oblivious.blackbookGet('commentcount');
					
					$.each(localMeta,function(i,obj){
						var tmpEntry = {
								'category':'',
								'entryid':'',
								'meta':'',
								'entryhash':'',
								'blackbook':true,
								'visiblename':'(no alias)'
						};
						if(obj.value != ''){
							var tmpRaw = String(obj.key).split(":");
							var tmpID = tmpRaw[0];
							var tmpCat = tmpRaw[1];
							
							tmpEntry.entryid = tmpID;
							tmpEntry.hash = $scope.getHash(tmpID);
							tmpEntry.category = tmpCat;
							tmpEntry.meta = obj.value;
							console.log('dimelo pina',tmpEntry);
							$.each(localAliases,function(j,aliasObj){
								var aliasRaw = String(aliasObj.key).split(":");
								var aliasID = aliasRaw[0];
								var aliasCat = aliasRaw[1];
								
								if(aliasID == tmpEntry.entryid && aliasCat == tmpEntry.category){
									tmpEntry.visiblename = String(aliasObj.value);
								}
							});
							$.each(localCommCount,function(j,cObj){
								console.log('cObj',cObj);
								
								if(String(cObj.key) === String(tmpEntry.entryid + ":" + tmpEntry.category) ){
									tmpEntry.commentcount = cObj.value;
									return false;
								}
							});
							if(typeof tmpEntry.category != 'undefined' && typeof tmpEntry.entryid != 'undefined' && typeof tmpEntry.commentcount != 'undefined' && tmpEntry.commentcount != -1 && tmpEntry.commentcount != '-1'){
								Entries.push(tmpEntry);
							}
						}
					});
					console.log('Entries:'+Entries.length);
					return Entries;	
				};
				
					
				$scope.entries = $scope.getBlackbookEntries();
				
				//blackbook check
				$scope.bbcheck = function(){
					console.log('bbcheck!');
					var Entries =[];
					var localEntries = [];
					var localMeta = oblivious.blackbookGet('meta');
					var localCommCount = oblivious.blackbookGet('commentcount');
					$.each(localMeta,function(i,obj){
						var tmpEntry = {
								'category':'',
								'entryid':'',
								'visiblename':'',
								'commentcount':'',
						};
						var tmpRaw = String(obj.key).split(":");
						var tmpID = tmpRaw[0];
						var tmpCat = tmpRaw[1];
						
						tmpEntry.entryid = tmpID;
						tmpEntry.visiblename = tmpID;
						
						tmpEntry.category = tmpCat;

						console.log('tmpEntry',tmpEntry);
						
						$.each(localCommCount,function(j,cObj){
							console.log('cObj',cObj,String(cObj.key) === String(tmpEntry.entryid+ ":" + tmpEntry.category) );
							
							if(String(cObj.key) === String(tmpEntry.entryid+ ":" + tmpEntry.category) ){
								tmpEntry.commentcount = cObj.value;
								return false;
							}
						});
						
						if(typeof tmpEntry.category != 'undefined' && typeof tmpEntry.entryid != 'undefined' && typeof tmpEntry.commentcount != 'undefined' && tmpEntry.commentcount != -1 && tmpEntry.commentcount != '-1'){
								
							localEntries.push( String(tmpEntry.entryid+ ":" + tmpEntry.category) );
							Entries.push(tmpEntry);
							
						}

							
					});
					if(Entries.length == 0)
						return false;
					console.log('Entries',Entries);
					var currEntries = [];

			    	var newCommentCount = {};
			    	
					$.post( "https://www.hazedaily.com/api/blackbook/", {blackbookdata:Entries})
					  .done(function( data ) {
					    var hasChanged = [];
					    	data = JSON.parse(data);
					    	console.log('data from bb check',data);
					    	
						    $.each(data,function(i,obj){
						    	//obj[0] is the entry
						    	console.log('obj',obj,obj.length);
						    	if(typeof obj.changed === 'undefined')
						    		return true; //skip
						    		
						    		
						    		if(obj.changed){
						    			var tmp = {
						    					'entryid':obj.entryid,
						    					'category':obj.category,
						    					'visiblename':obj.entryid
						    			};
						    			hasChanged.push(tmp);

						    		}
						    		currEntries.push(obj);	
						    		
						    });
						    
						    $scope.$apply(function() {
						    	$scope.hasChanged = hasChanged;
						    });
						    
							//if @ blackbook
							if($location.path() == '/blackbook'){
								$.each(localEntries,function(ii,encodedentry){
									var tmpRaw = String(encodedentry).split(":");
									var tmpID = tmpRaw[0];
									var tmpCat = tmpRaw[1];
									
									var foundEntry = false;
									$.each(currEntries,function(jj,obj){
								    	//String(tmpEntry.entryid+ ":" + tmpEntry.category)
										console.log('obj-checkit',obj);
										if(obj.entryid == tmpID && obj.category == tmpCat){
											foundEntry = true;
											return false;
										}
										
								    });
									if(!foundEntry){
										console.log('entry no longer exists!');
								    	oblivious.blackbookSet('commentcount',tmpID +":"+tmpCat ,-1);
										location.reload(true);
									}else{
										console.log('entry still exists amigo');
									}
								});
							}
							
					  }, "json");
				};
				$scope.bbcheck();
				window.setInterval($scope.bbcheck(),30000); //check every 30s
				
				
				
				$scope.$on('$viewContentLoaded', function(){
					 // Run after view loaded.
				// Run after view loaded.
							$('.dropdown')
					  		.dropdown({
					  		    //dropdown settings
				  		    })
					  		;
						 
							$('.checkbox')
					  		.checkbox();
				 	$('.action-button,#invite-modal-open').off('click').on('click',function(){
					 		var tmpData = $(this).data();
					 		console.log('tmpData',tmpData);
					 		
					 	
					 		if(typeof tmpData.modalid !== 'undefined'){
					 			
					 			$('#'+tmpData.modalid).transition('scale')
					 			;
					 			$('#'+tmpData.hidecontentids).transition('scale')
					 			;			
					 		}
					 	});
					 	$("#clear-blackbook-button").on("click",function(){
								
								oblivious.blackbookClear();
								$("html, body").animate({ scrollTop: 0 }, "slow");
								location.reload(true);
						});
					 	
					});
				
				
			});
			app.controller('CreateCtrl',function($scope,$location,$routeParams){
				
				
				
				$scope.$on('$viewContentLoaded', function(){
					oblivious._onchange('addimage-input',function(){
						var imgData = String(this);
						$scope.$apply(function() {
							$scope.newentry.image = imgData;
						});
						// Run after view loaded.
						$('.dropdown')
				  		.dropdown({
				  		    //dropdown settings
			  		    })
				  		;
					 
						$('.checkbox')
				  		.checkbox();
					});
					$('#cryptotoggle').on("change",function(){
						
						if($(this).checkbox('is checked')){
							console.log('enable crypto');	
							oblivious._enableClientCrypto();
						}else{
							console.log('disable crypto');
							oblivious._disableClientCrypto();
						}
					});
					
					$("#metadata_entry").on("change",function(){
						$("#metadata_preview").show();
						if($(this).val() == '')
							$("#metadata_preview").hide();
						
						var tmpJSON = $(this).val();
						try{
							tmpJSON = JSON.parse(tmpJSON);
							var tmpMeta = {};
							for (var attrname in tmpJSON) { 
								tmpMeta[attrname] = tmpJSON[attrname]; 
							}
							$scope.$apply(function() {
								$scope.newentry.meta = tmpMeta;
							});
							$("#metadata_preview").val( JSON.stringify(tmpJSON,null,2) );
						}catch(e){
							console.log('not valid JSON');
						}
						
					});	
				});
				
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
				$scope.newentry =  {
						'image':'',
						'clientsidecrypto':'',
						'password':'',
						'message':'',
						'expiration':'',
						'metadata':'',
					};
				
				$scope.submitNewEntry = function(){
					var entryDetails = {
						'image':'',
						'clientsidecrypto':'',
						'password':'',
						'message':'',
						'expiration':'',
						'metadata':'',
						'meta':'',
						'category':'public',
						'containsimage':0
					};
					entryDetails.clientsidecrypto = $('#cryptotoggle').checkbox('is checked');
					entryDetails.password = $('#entry-password').val();
					entryDetails.message = $("#entry-text").val();
					entryDetails.expiration = $("#entry-expiration").val();
					entryDetails.metadata = $("#metadata_entry").val();
					entryDetails.image = $scope.newentry.image;
					if(entryDetails.image != ''){
						entryDetails.containsimage = 1;
					}
					console.log('entry-details',entryDetails);
					
					var d ={ data:String(entryDetails.message),
				             expire:entryDetails.expiration,
				             opendiscussion: 1,
				             category:entryDetails.category,
				             userkey:entryDetails.password,
				             imgdata:entryDetails.image,
				             containsimage:entryDetails.containsimage
					     };
					for (var attrname in $scope.newentry.meta) { d[attrname] = $scope.newentry.meta[attrname]; }

					if(entryDetails.password != ''){
						//krypi-password
						//(newEntry,category,userKey,img_data){
						d.userkey = entryDetails.password;
					}
					if(entryDetails.image != ''){
						d.imgdata = entryDetails.image;
						d.containsimage = 1;
					}
					console.log('d',d);
					if(d.imgdata || d.userkey){
						console.log('krypi entry');
						oblivious.addKrypiEntry(d,function(){
							console.log('added!');
						});
					}else{
						console.log('regular entry');
						oblivious.addEntry(d,function(){
							console.log('added!')
						});
					}
					$('#addentryform')[0].reset();
					$("html, body").animate({ scrollTop: 0 }, "slow");
					
				};
			});
			app.controller('HazeInviteViewCtrl',function($scope,$location,$routeParams){
				$scope.entryid = $routeParams.eid;
				$scope.category = $routeParams.category;
				
				$scope.generateInvite = function(){
					if($("#invite-pwd").val() != ''){
							oblivious._generateInvite($scope.entryid ,$scope.category);
							//clear fields
							$("#invite-pwd").val('');
							$("#invite-img-wrapper").fadeIn();
					}
				};
				$scope.$on('$viewContentLoaded', function(){});
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
			});
			app.controller('HazeProcessInviteViewCtrl',function($scope,$location,$routeParams){
				
				$scope.process = function(){
					oblivious._processInvite('#invite-status');
				};
				$scope.$on('$viewContentLoaded', function(){
					
					document.getElementById('decode-input').onchange = function(input) {
						var file    = document.getElementById('decode-input').files[0];
						if ( file ) {
					        var FR= new FileReader();
					        FR.onload = function(e) {
					        	var password = prompt('Enter password (leave empty if none)');
					        	
								GhostPixels.decode(password,e.target.result).then(function(decodedMessage){
									
									$("#encodedinvite-input").val(decodedMessage);
									$("#encodedinvite-input").data('pwd',password);
									
					        	});
					        	
					        };       
					        FR.readAsDataURL( file );
					    }
					};
					$("#submit-invite-button").on("click",function(){
						oblivious._processInvite('#invite-status');
							$("#inviteform")[0].reset();
					});
					
				});
				$scope.getHash = function(d){
					console.log('md5',md5(d));
					return md5(d);
				};
				$scope.getIdenticon = function(str){
					var identicon = new Identicon(str, 420).toString();
					identicon = 'data:image/png;base64,' + identicon;
					return identicon;
				};
				$scope.core_data = {};
				
			});
			app.config(['$routeProvider',
			      	  function($routeProvider) {
			      	    $routeProvider.
			      	      when('/blackbook', {
			      		        templateUrl: 'templates/blackbook.html',
			      		        controller: 'BlackbookCtrl'
			      	      }).
			      	      when('/create', {
			      		        templateUrl: 'templates/create.html',
			      		        controller: 'CreateCtrl'
			      	      }).
			      	    when('/view/:category/:eid', {
		      		        templateUrl: 'templates/view.html',
		      		        controller: 'HazeViewCtrl'
		      	      	}).
		      	      when('/invite/:category/:eid', {
		      		        templateUrl: 'templates/invite.html',
		      		        controller: 'HazeInviteViewCtrl'
		      	      	}).
		      	      when('/processinvite', {
		      		        templateUrl: 'templates/processinvite.html',
		      		        controller: 'HazeProcessInviteViewCtrl'
		      	      	}).
			      	      otherwise({
			      	        redirectTo: '/blackbook'
			      	      });
			      	  }]);
			
			app.run(['$rootScope','$location', '$routeParams', function($rootScope, $location, $routeParams) {
			    $rootScope.$on('$routeChangeSuccess', function(e, current, pre) {
			      console.log('Current route name: ' + $location.path());
			      
			     
			      
			      
			      // Get all URL parameter
			      console.log($routeParams);
			      $("#homebtn,#blackbookbtn,#createbtn,#settingsbtn").find('.button').removeClass('basic').addClass('basic');
			      	$("#homebtn,#blackbookbtn,#createbtn,#settingsbtn").removeClass('active');
				      switch($location.path()){
				      case "/home":
				    	  $("#homebtn").addClass('active');
				    	  $("#homebtn").find('.button').removeClass('basic');
				    	  break;
				      case "/blackbook":
				    	  $("#blackbookbtn").addClass('active');
				    	  $("#blackbookbtn").find('.button').removeClass('basic');
				    	  break;
				      case "/create":
				    	  $("#createbtn").addClass('active');
				    	  $("#createbtn").find('.button').removeClass('basic');
				    	  break;
				      case "/settings":
				    	  $("#settingsbtn").addClass('active');
				    	  $("#settingsbtn").find('.button').removeClass('basic');
				    	  break;
				      }
			    });
			  }]);
			</script>
			
			<script>
			
			document.addEventListener("deviceready", onDeviceReady, false);
			function onDeviceReady() {
				$(document).on('click', 'img.processed-entry-image', function(event) {
			        event.preventDefault();
			        var tmpSRC = $(this).attr('src');
			        
			        var canvas = canvas = document.createElement('canvas');
			    	canvas.width = GhostPixels.dimensions.width;
			    	canvas.height = GhostPixels.dimensions.height;
			    	var img = new Image();
			        img.onload = function() {
			            var ctx = canvas.getContext('2d');
			            ctx.canvas.width = img.width;
			            ctx.canvas.height = img.height;
			            ctx.drawImage(img, 0, 0);
			            
			            window.canvas2ImagePlugin.saveImageDataToLibrary(
				                function(msg){
				                    alert('File has been saved to gallery.');
				                },
				                function(err){
				                    alert('File could not be saved to gallery.');
				                },
				                canvas
				            );
			        };
			        img.src = tmpSRC;
			        
			    });
			}; //end onDeviceReady
			
			</script>
	</body>
</html>